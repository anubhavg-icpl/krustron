apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: applications.krustron.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: krustron.io
  names:
    kind: Application
    listKind: ApplicationList
    plural: applications
    singular: application
    shortNames:
      - app
      - kapp
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - source
                - destination
              properties:
                project:
                  type: string
                  default: default
                  description: The project this application belongs to
                source:
                  type: object
                  required:
                    - repoURL
                  properties:
                    repoURL:
                      type: string
                      description: URL to the repository
                    path:
                      type: string
                      description: Path within the repository
                    targetRevision:
                      type: string
                      default: HEAD
                      description: Target revision (branch, tag, or commit)
                    chart:
                      type: string
                      description: Helm chart name (for Helm apps)
                    helm:
                      type: object
                      properties:
                        valueFiles:
                          type: array
                          items:
                            type: string
                        values:
                          type: string
                        parameters:
                          type: array
                          items:
                            type: object
                            properties:
                              name:
                                type: string
                              value:
                                type: string
                        releaseName:
                          type: string
                    kustomize:
                      type: object
                      properties:
                        namePrefix:
                          type: string
                        nameSuffix:
                          type: string
                        images:
                          type: array
                          items:
                            type: string
                        commonLabels:
                          type: object
                          additionalProperties:
                            type: string
                        commonAnnotations:
                          type: object
                          additionalProperties:
                            type: string
                destination:
                  type: object
                  required:
                    - server
                  properties:
                    server:
                      type: string
                      description: Kubernetes API server URL
                    namespace:
                      type: string
                      description: Target namespace
                syncPolicy:
                  type: object
                  properties:
                    automated:
                      type: object
                      properties:
                        prune:
                          type: boolean
                          default: false
                        selfHeal:
                          type: boolean
                          default: false
                        allowEmpty:
                          type: boolean
                          default: false
                    syncOptions:
                      type: array
                      items:
                        type: string
                    retry:
                      type: object
                      properties:
                        limit:
                          type: integer
                        backoff:
                          type: object
                          properties:
                            duration:
                              type: string
                            factor:
                              type: integer
                            maxDuration:
                              type: string
                ignoreDifferences:
                  type: array
                  items:
                    type: object
                    properties:
                      group:
                        type: string
                      kind:
                        type: string
                      name:
                        type: string
                      namespace:
                        type: string
                      jsonPointers:
                        type: array
                        items:
                          type: string
                      jqPathExpressions:
                        type: array
                        items:
                          type: string
            status:
              type: object
              properties:
                sync:
                  type: object
                  properties:
                    status:
                      type: string
                      enum:
                        - Synced
                        - OutOfSync
                        - Unknown
                    comparedTo:
                      type: object
                      properties:
                        source:
                          type: object
                          properties:
                            repoURL:
                              type: string
                            path:
                              type: string
                            targetRevision:
                              type: string
                        destination:
                          type: object
                          properties:
                            server:
                              type: string
                            namespace:
                              type: string
                    revision:
                      type: string
                health:
                  type: object
                  properties:
                    status:
                      type: string
                      enum:
                        - Healthy
                        - Progressing
                        - Degraded
                        - Suspended
                        - Missing
                        - Unknown
                    message:
                      type: string
                operationState:
                  type: object
                  properties:
                    operation:
                      type: object
                      properties:
                        sync:
                          type: object
                          properties:
                            revision:
                              type: string
                            prune:
                              type: boolean
                            dryRun:
                              type: boolean
                    phase:
                      type: string
                      enum:
                        - Running
                        - Succeeded
                        - Failed
                        - Error
                        - Terminating
                    message:
                      type: string
                    startedAt:
                      type: string
                      format: date-time
                    finishedAt:
                      type: string
                      format: date-time
                resources:
                  type: array
                  items:
                    type: object
                    properties:
                      group:
                        type: string
                      version:
                        type: string
                      kind:
                        type: string
                      namespace:
                        type: string
                      name:
                        type: string
                      status:
                        type: string
                      health:
                        type: object
                        properties:
                          status:
                            type: string
                          message:
                            type: string
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      message:
                        type: string
                      reason:
                        type: string
                reconciledAt:
                  type: string
                  format: date-time
                observedAt:
                  type: string
                  format: date-time
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Sync Status
          type: string
          jsonPath: .status.sync.status
        - name: Health
          type: string
          jsonPath: .status.health.status
        - name: Revision
          type: string
          jsonPath: .status.sync.revision
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: pipelines.krustron.io
spec:
  group: krustron.io
  names:
    kind: Pipeline
    listKind: PipelineList
    plural: pipelines
    singular: pipeline
    shortNames:
      - pipe
      - kpipe
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - stages
              properties:
                applicationRef:
                  type: object
                  properties:
                    name:
                      type: string
                    namespace:
                      type: string
                triggers:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        enum:
                          - webhook
                          - schedule
                          - manual
                          - gitPush
                          - gitPullRequest
                      webhook:
                        type: object
                        properties:
                          secretRef:
                            type: object
                            properties:
                              name:
                                type: string
                              key:
                                type: string
                      schedule:
                        type: object
                        properties:
                          cron:
                            type: string
                          timezone:
                            type: string
                      git:
                        type: object
                        properties:
                          branches:
                            type: array
                            items:
                              type: string
                          paths:
                            type: array
                            items:
                              type: string
                stages:
                  type: array
                  items:
                    type: object
                    required:
                      - name
                      - type
                    properties:
                      name:
                        type: string
                      type:
                        type: string
                        enum:
                          - build
                          - test
                          - security
                          - deploy
                          - approval
                          - custom
                      dependsOn:
                        type: array
                        items:
                          type: string
                      build:
                        type: object
                        properties:
                          image:
                            type: string
                          dockerfile:
                            type: string
                          context:
                            type: string
                          buildArgs:
                            type: object
                            additionalProperties:
                              type: string
                          registry:
                            type: string
                          tags:
                            type: array
                            items:
                              type: string
                      test:
                        type: object
                        properties:
                          image:
                            type: string
                          command:
                            type: array
                            items:
                              type: string
                          env:
                            type: object
                            additionalProperties:
                              type: string
                      security:
                        type: object
                        properties:
                          scanType:
                            type: string
                            enum:
                              - vulnerability
                              - policy
                              - both
                          failOnCritical:
                            type: boolean
                          failOnHigh:
                            type: boolean
                      deploy:
                        type: object
                        properties:
                          environment:
                            type: string
                          strategy:
                            type: string
                            enum:
                              - recreate
                              - rolling
                              - blueGreen
                              - canary
                          canary:
                            type: object
                            properties:
                              steps:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    weight:
                                      type: integer
                                    pause:
                                      type: object
                                      properties:
                                        duration:
                                          type: string
                      approval:
                        type: object
                        properties:
                          approvers:
                            type: array
                            items:
                              type: string
                          minApprovals:
                            type: integer
                          timeout:
                            type: string
                      custom:
                        type: object
                        properties:
                          image:
                            type: string
                          command:
                            type: array
                            items:
                              type: string
                          script:
                            type: string
                          env:
                            type: object
                            additionalProperties:
                              type: string
                      timeout:
                        type: string
                      retries:
                        type: integer
                notifications:
                  type: object
                  properties:
                    slack:
                      type: object
                      properties:
                        channel:
                          type: string
                        onSuccess:
                          type: boolean
                        onFailure:
                          type: boolean
                    email:
                      type: object
                      properties:
                        recipients:
                          type: array
                          items:
                            type: string
                        onSuccess:
                          type: boolean
                        onFailure:
                          type: boolean
            status:
              type: object
              properties:
                lastRun:
                  type: object
                  properties:
                    id:
                      type: string
                    status:
                      type: string
                      enum:
                        - Pending
                        - Running
                        - Succeeded
                        - Failed
                        - Cancelled
                    startedAt:
                      type: string
                      format: date-time
                    finishedAt:
                      type: string
                      format: date-time
                    stages:
                      type: array
                      items:
                        type: object
                        properties:
                          name:
                            type: string
                          status:
                            type: string
                          startedAt:
                            type: string
                            format: date-time
                          finishedAt:
                            type: string
                            format: date-time
                          message:
                            type: string
                runCount:
                  type: integer
                successCount:
                  type: integer
                failureCount:
                  type: integer
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      message:
                        type: string
                      reason:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Last Run
          type: string
          jsonPath: .status.lastRun.status
        - name: Runs
          type: integer
          jsonPath: .status.runCount
        - name: Success
          type: integer
          jsonPath: .status.successCount
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: clusters.krustron.io
spec:
  group: krustron.io
  names:
    kind: Cluster
    listKind: ClusterList
    plural: clusters
    singular: cluster
    shortNames:
      - kc
      - kcluster
  scope: Cluster
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              required:
                - server
              properties:
                name:
                  type: string
                server:
                  type: string
                  description: Kubernetes API server URL
                config:
                  type: object
                  properties:
                    bearerToken:
                      type: string
                    tlsClientConfig:
                      type: object
                      properties:
                        insecure:
                          type: boolean
                        caData:
                          type: string
                        certData:
                          type: string
                        keyData:
                          type: string
                    awsAuthConfig:
                      type: object
                      properties:
                        clusterName:
                          type: string
                        roleARN:
                          type: string
                    execProviderConfig:
                      type: object
                      properties:
                        command:
                          type: string
                        args:
                          type: array
                          items:
                            type: string
                        env:
                          type: object
                          additionalProperties:
                            type: string
                connectionState:
                  type: object
                  properties:
                    status:
                      type: string
                    message:
                      type: string
                    attemptedAt:
                      type: string
                      format: date-time
                namespaces:
                  type: array
                  items:
                    type: string
                  description: List of namespaces to manage (empty means all)
                labels:
                  type: object
                  additionalProperties:
                    type: string
                annotations:
                  type: object
                  additionalProperties:
                    type: string
            status:
              type: object
              properties:
                connectionState:
                  type: object
                  properties:
                    status:
                      type: string
                      enum:
                        - Connected
                        - Disconnected
                        - Unknown
                    message:
                      type: string
                    attemptedAt:
                      type: string
                      format: date-time
                serverVersion:
                  type: string
                cacheInfo:
                  type: object
                  properties:
                    resourcesCount:
                      type: integer
                    lastCacheSyncTime:
                      type: string
                      format: date-time
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                      message:
                        type: string
                      reason:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Server
          type: string
          jsonPath: .spec.server
        - name: Connection
          type: string
          jsonPath: .status.connectionState.status
        - name: Version
          type: string
          jsonPath: .status.serverVersion
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
